---
title: "Untitled"
format: revealjs
execute:
  cache: true
---

```{r setup}
#| cache: false
library(lubridate)
library(ggplot2)
library(data.table)
library(metR)
library(rcdo)

cdo_options_set("-L")
source(here::here("R/functions.R"))
source(here::here("R/datasets.R"))
source(here::here("R/ggplot.R"))
```

## Experiments

Idea:

1.  Use initial conditions from a very average day/month.
2.  Run experiments with changing sea ice initial condtions:
3.  Experiments with high initial sea ice
4.  Experiments with low sea ice.

## Identifying "average" starting points

1.  Compute an error metric between dates and the climatology and chose the lowest.
2.  Three possible metrics:
    1.  RMSE
    2.  IIEE
    3.  Extent difference (IIEE, is better overall because it also includes location error, so I discard this)

------------------------------------------------------------------------

```{r}
s2_monthly <- S2_reanalysis() |> 
  cdo_monmean() 

s2_monthly_clim <- S2_reanalysis() |> 
  climatology() |> 
  cdo_monmean()


rmse_clim <- cdo_ymonsub(s2_monthly, s2_monthly_clim) |> 
  cdo_sqr() |> 
  cdo_fldmean() |> 
  cdo_sqrt() |> 
  cdo_chname("aice", "rmse") |> 
  cdo_execute() |> 
  ReadNetCDF("rmse") |> 
  _[, .(time, rmse)] |>
  melt(id.vars = "time") 

```

```{r}
s2_monthly_edge <- s2_monthly |> 
  cdo_gtc(0.15) |> 
  cdo_execute()

s2_monthly_clim_edge <- s2_monthly_clim |> 
  cdo_gtc(0.15) |> 
  cdo_execute()

iiee_clim <- cdo_ymonne(s2_monthly_edge, s2_monthly_clim_edge) |>
  cdo_fldint() |>
  cdo_chname("aice", "iiee") |> 
  cdo_execute() |> 
  ReadNetCDF("iiee") |> 
  _[, .(time, iiee)] |> 
  melt(id.vars = "time") 

```

```{r}
#| fig.cap: Standardised value of each errror. 

rbind(iiee_clim, rmse_clim) |> 
  # _[, anomaly := value/median(value), by = .(variable, month(time))] |>
  _[, value := value/sd(value, na.rm = TRUE), by = .(variable)] |>
  ggplot(aes(time, value)) +
  geom_line(aes(color = variable)) +
  labs(color = "Error") +
  facet_wrap(~ month(time))
```

------------------------------------------------------------------------

```{r}
#| fig.cap: Relationship between IIEE and RMSE with respeceet to climatology for each month. 
rbind(iiee_clim, rmse_clim) |> 
  # _[, anomaly := value/median(value), by = .(variable, month(time))] |>
  # _[, anomaly := as.numeric(scale(anomaly)), by = .(variable)] |> 
  dcast(time ~ variable, value.var = "value") |> 
  ggplot(aes(iiee, rmse)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ month(time))
```

```{r}
min_error <- rbind(iiee_clim, rmse_clim)  |> 
  copy() |> 
  _[, month := month(time)] |> 
  _[, .SD[which.min(value)], by = .(variable, month)] 

s2_climatology <- s2_monthly_clim |> 
  cdo_execute() |> 
  ReadNetCDF(c(clim = "aice")) |> 
  setnames("time", "clim_time")

min_error_data <- s2_monthly |> 
  cdo_execute() |> 
   ReadNetCDF("aice", subset = list(time = as.list(min_error$time))) |> 
  _[, clim_time := update(time, year = 2000)] |> 
  _[min_error, on = .NATURAL, allow.cartesian = TRUE]
  
  
```

------------------------------------------------------------------------
```{r}
breaks <- seq(-0.9, 0.9, by = 0.1)
```
```{r}
min_error_data |> 
  _[variable == "iiee"] |> 
  _[, label := paste0(formatC(month(time), width = "2", flag = "0"), " - ", as.character(as.Date(time)))] |> 
  s2_climatology[i = _, on = .NATURAL] |> 
  ggplot(aes(xgrid, ygrid)) +
  geom_contour_fill(aes(z = aice - clim, fill = after_stat(level)), breaks = breaks) +
  geom_contour2(aes(z = aice), breaks = 0.15) +
  geom_contour2(aes(z = clim), breaks = 0.15, linetype = 2) +
  scale_fill_divergent_discretised() +
  geomcoord_antarctica +
  geom_antarctica_path +
  facet_wrap(~ label, ncol = 6) +
  wide_legend +
  labs(title = "iiee")
```

------------------------------------------------------------------------


```{r}
min_error_data |> 
  _[variable == "rmse"] |> 
  _[, label := paste0(formatC(month(time), width = "2", flag = "0"), " - ", as.character(as.Date(time)))] |> 
  s2_climatology[i = _, on = .NATURAL] |> 
  ggplot(aes(xgrid, ygrid)) +
  geom_contour_fill(aes(z = aice - clim, fill = after_stat(level)), breaks = breaks) +
  geom_contour2(aes(z = aice), breaks = 0.15) +
  geom_contour2(aes(z = clim), breaks = 0.15, linetype = 2) +
  scale_fill_divergent_discretised() +
  geomcoord_antarctica +
  geom_antarctica_path +
  facet_wrap(~ label, ncol = 6) +
  wide_legend +
  labs(title = "rmse")
```
